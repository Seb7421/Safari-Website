---
import LinkBlend from "@components/global/LinkBlend.astro";
import { getLangFromUrl, useTranslations, useTranslatedPath } from "@i18n/utils";
import type { ImageMetadata } from "astro";

const heroImagesImport = import.meta.glob<{ default: ImageMetadata }>(
        "@assets/images/landing-page/*.{png,jpg,jpeg,webp}",
        { eager: true },
);
const heroImages = Object.entries(heroImagesImport)
        .sort(([a], [b]) => a.localeCompare(b))
        .map(([, imageModule]) => imageModule?.default?.src)
        .filter(Boolean);

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
const translatePath = useTranslatedPath(lang);
---

<section
        id="hero"
        class="section home-dark-section hero min-h-screen"
        data-hero-images={JSON.stringify(heroImages)}
>
        <div class="hero__background">
                <div class="hero__background-inner">
                        <div class="hero__background-layer is-active"></div>
                        <div class="hero__background-layer"></div>
                </div>
        </div>
        <div class="mx-auto flex h-full flex-col py-4 lg:py-10">
		<div class="relative flex flex-1 flex-col justify-around rounded-lg pb-10 pt-20 lg:rounded-2xl">
			<div class="flex justify-center">
				<h1 class="text-center font-display text-5xl font-extrabold uppercase sm:text-7xl md:text-8xl lg:text-9xl">
					<span>{t("hero.title.main")}</span>
					<span class="rotator relative inline-flex h-20 w-full justify-center md:h-24 lg:h-32">
						<span>{t("hero.title.1")}</span><span>{t("hero.title.2")}</span><span>{t("hero.title.3")}</span><span>
							{t("hero.title.4")}
						</span><span>{t("hero.title.1")}</span>
					</span>
				</h1>
			</div>
			<div class="flex flex-col items-center gap-5 text-center lg:gap-10">
				<p class="mt-8 max-w-3xl font-mono lg:text-lg">
					{t("hero.subtitle")}
				</p>
				<div class="flex flex-col items-center justify-center gap-3 lg:col-start-1">
					<div class="squircle-bg rounded-lg bg-zinc-900" data-cursor-hover data-cursor-parallax>
						<a
							class="flex h-10 w-full max-w-52 flex-1 items-center justify-center px-4 py-2 text-xl text-slate-200 transition-all hover:text-white sm:w-auto md:font-bold lg:h-10"
							aria-label="Contact Page"
							href={translatePath("/contact/")}>
							{t("contact")}
						</a>
					</div>

					<small>
						{t("or")}
						<LinkBlend id="go-projects-button" isButton={true}>{t("hero.scroll")}</LinkBlend>
					</small>
				</div>
			</div>
		</div>
	</div>
</section>

<style>
        .hero {
                padding-bottom: 0;
                position: relative;
                border-radius: inherit;
                overflow: hidden;
                background-color: black;
        }
        .hero__background {
                position: absolute;
                inset: 0;
                pointer-events: none;
                z-index: 0;
                display: flex;
        }
        .hero__background-inner {
                position: relative;
                width: 100%;
                height: 100%;
                overflow: hidden;
                transform-origin: top center;
                will-change: transform, border-radius;
        }
        .hero__background-layer {
                position: absolute;
                inset: 0;
                background-position: center;
                background-size: cover;
                background-repeat: no-repeat;
                opacity: 0;
        }
        .hero__background-layer.is-active {
                opacity: 1;
        }
        .hero__background-layer,
        .hero__background-layer.is-active {
                transition: opacity 0.8s ease-in-out;
        }
        .hero > .mx-auto {
                grid-column: 1 / span 12;
                position: relative;
                z-index: 1;
        }

	/* Hero appearance */
	.hero h1,
	.hero h2,
	.hero h3 {
		margin: 0;
	}
	.hero h1 {
		margin: 0;
		position: relative;
		overflow: hidden;
		visibility: hidden;
	}
	.hero h1 > div {
		position: relative;
		margin: 0;
	}
        /* Text rotator */
        .rotator > span {
                position: absolute;
        }

	.rotator > span:not(:nth-child(1)) {
		opacity: 0;
	}
</style>

<script>
        import { gsap } from "gsap";
        import { ScrollTrigger } from "gsap/ScrollTrigger";
        import { ScrollToPlugin } from "gsap/ScrollToPlugin";

        gsap.registerPlugin(ScrollTrigger, ScrollToPlugin);

        function init() {
                const heroSection = document.getElementById("hero");
                const heroHeading = document.querySelector(".hero h1");
                let heroImages = [];

                if (heroSection?.dataset.heroImages) {
                        try {
                                const parsed = JSON.parse(heroSection.dataset.heroImages);
                                heroImages = Array.isArray(parsed)
                                        ? parsed.filter((value) => typeof value === "string")
                                        : [];
                        } catch (error) {
                                heroImages = [];
                        }
                }
                const backgroundInner = heroSection?.querySelector(".hero__background-inner");
                const backgroundLayers = heroSection
                        ? Array.from(heroSection.querySelectorAll(".hero__background-layer"))
                        : [];

                if (heroSection && backgroundInner && backgroundLayers.length >= 2 && Array.isArray(heroImages) && heroImages.length > 0) {
                        let currentIndex = 0;
                        let activeLayer = backgroundLayers[0];
                        let inactiveLayer = backgroundLayers[1];

                        gsap.set(backgroundInner, {
                                scaleX: 1,
                                borderBottomLeftRadius: 0,
                                borderBottomRightRadius: 0,
                        });
                        activeLayer.style.backgroundImage = `url(${heroImages[currentIndex]})`;
                        activeLayer.classList.add("is-active");

                        const setUpcomingImage = () => {
                                if (heroImages.length > 1) {
                                        const nextIndex = (currentIndex + 1) % heroImages.length;
                                        inactiveLayer.style.backgroundImage = `url(${heroImages[nextIndex]})`;
                                }
                        };

                        setUpcomingImage();

                        const swapLayers = () => {
                                activeLayer.classList.remove("is-active");
                                inactiveLayer.classList.add("is-active");

                                const temp = activeLayer;
                                activeLayer = inactiveLayer;
                                inactiveLayer = temp;
                        };

                        const updateBackground = () => {
                                if (heroImages.length <= 1) {
                                        return;
                                }

                                currentIndex = (currentIndex + 1) % heroImages.length;
                                inactiveLayer.style.backgroundImage = `url(${heroImages[currentIndex]})`;

                                requestAnimationFrame(() => {
                                        swapLayers();
                                        setUpcomingImage();
                                });
                        };

                        if (heroImages.length > 1) {
                                setInterval(updateBackground, 2000);
                        }

                        ScrollTrigger.create({
                                trigger: heroSection,
                                start: "top top",
                                end: "bottom top",
                                onUpdate: (self) => {
                                        const progress = gsap.utils.clamp(0, 1, self.progress);
                                        const scale = 1 - 0.12 * progress;
                                        const radius = 64 * progress;
                                        gsap.set(backgroundInner, {
                                                scaleX: scale,
                                                borderBottomLeftRadius: `${radius}px`,
                                                borderBottomRightRadius: `${radius}px`,
                                        });
                                },
                        });
                }

                if (heroHeading) {
                        const staticPart = heroHeading.querySelector(":scope > span:first-child");
                        const rotatorContainer = heroHeading.querySelector(":scope > span.rotator");
                        const rotatorWords = rotatorContainer ? Array.from(rotatorContainer.querySelectorAll(":scope > span")) : [];

                        gsap.set(heroHeading, { visibility: "visible" });

                        const introTimeline = gsap.timeline();

                        if (staticPart) {
                                introTimeline.from(staticPart, {
                                        duration: 1.2,
                                        yPercent: 100,
                                        opacity: 0,
                                        ease: "power4.out",
                                });
                        }

                        if (rotatorWords.length > 0) {
                                gsap.set(rotatorWords, { yPercent: 100, opacity: 0 });
                                gsap.set(rotatorWords[0], { yPercent: 0, opacity: 1 });

                                introTimeline.from(
                                        rotatorWords[0],
                                        {
                                                duration: 1,
                                                yPercent: 100,
                                                opacity: 0,
                                                ease: "power4.out",
                                        },
                                        "-=0.6",
                                );

                                introTimeline.then(() => {
                                        const rotatorTimeline = gsap.timeline({ repeat: -1 }).timeScale(0.5);

                                        rotatorWords.forEach((word, index) => {
                                                const wordTimeline = gsap.timeline();

                                                if (index !== 0) {
                                                        wordTimeline.from(word, { duration: 1, yPercent: 100, opacity: 0, ease: "power4.out" });
                                                }

                                                if (index !== rotatorWords.length - 1) {
                                                        wordTimeline.to(word, { duration: 1, yPercent: -100, opacity: 0, ease: "power4.out" });
                                                }

                                                rotatorTimeline.add(wordTimeline, index === 0 ? 0 : index - 1);
                                        });
                                });
                        }
                }

                var goProjectsButton = document.getElementById("go-projects-button");
                goProjectsButton?.addEventListener("click", function () {
			gsap.to(window, { duration: 0.5, scrollTo: "#projects" });
		});
	}

	document.removeEventListener("DOMContentLoaded", init); // astro:page-load
	document.addEventListener("DOMContentLoaded", init); // astro:page-load
</script>
